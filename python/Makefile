# ============================================================================
# SIGHT ONE (ç°æ ONE) - Makefile
# Quick commands for development and deployment
# ============================================================================

.PHONY: help install install-dev test clean lint format check run

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# Python è§£é‡Šå™¨
PYTHON := python3
PIP := $(PYTHON) -m pip

# é¡¹ç›®ç›®å½•
PROJECT_DIR := $(shell pwd)

# ============================================================================
# å¸®åŠ©ä¿¡æ¯
# ============================================================================

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "=========================================="
	@echo "  SIGHT ONE - Make å‘½ä»¤"
	@echo "=========================================="
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

# ============================================================================
# å®‰è£…
# ============================================================================

install: ## å®‰è£…ç”Ÿäº§ä¾èµ–
	@echo "ğŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–..."
	$(PIP) install --upgrade pip setuptools wheel
	$(PIP) install -r requirements.txt
	@echo "âœ… å®‰è£…å®Œæˆ"

install-dev: ## å®‰è£…å¼€å‘ä¾èµ–
	@echo "ğŸ“¦ å®‰è£…å¼€å‘ä¾èµ–..."
	$(PIP) install --upgrade pip setuptools wheel
	$(PIP) install -r requirements-dev.txt
	@echo "âœ… å®‰è£…å®Œæˆ"

install-gpu: ## å®‰è£… GPU æ”¯æŒ (CUDA 11.8)
	@echo "ğŸ® å®‰è£… PyTorch with CUDA 11.8..."
	$(PIP) install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
	@echo "âœ… GPU æ”¯æŒå®‰è£…å®Œæˆ"

# ============================================================================
# æµ‹è¯•
# ============================================================================

test: ## è¿è¡Œæ‰€æœ‰æµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	$(PYTHON) test_installation.py
	@echo "âœ… æµ‹è¯•å®Œæˆ"

test-env: ## æµ‹è¯•ç¯å¢ƒé…ç½®
	@echo "ğŸ” æ£€æŸ¥ç¯å¢ƒ..."
	$(PYTHON) test_installation.py

test-pytest: ## è¿è¡Œ pytest å•å…ƒæµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œ pytest..."
	pytest -v --tb=short

test-cov: ## è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
	@echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š..."
	pytest --cov=. --cov-report=html --cov-report=term
	@echo "âœ… æŠ¥å‘Šå·²ç”Ÿæˆ: htmlcov/index.html"

# ============================================================================
# ä»£ç è´¨é‡
# ============================================================================

lint: ## ä»£ç æ£€æŸ¥ (flake8)
	@echo "ğŸ” è¿è¡Œ flake8..."
	flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
	flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

format: ## ä»£ç æ ¼å¼åŒ– (black)
	@echo "âœ¨ æ ¼å¼åŒ–ä»£ç ..."
	black . --line-length=100
	isort . --profile black
	@echo "âœ… æ ¼å¼åŒ–å®Œæˆ"

format-check: ## æ£€æŸ¥ä»£ç æ ¼å¼
	@echo "ğŸ” æ£€æŸ¥ä»£ç æ ¼å¼..."
	black . --check --line-length=100
	isort . --check-only --profile black

type-check: ## ç±»å‹æ£€æŸ¥ (mypy)
	@echo "ğŸ” è¿è¡Œç±»å‹æ£€æŸ¥..."
	mypy . --ignore-missing-imports

check: lint format-check type-check ## è¿è¡Œæ‰€æœ‰ä»£ç æ£€æŸ¥

# ============================================================================
# æ¸…ç†
# ============================================================================

clean: ## æ¸…ç†ä¸´æ—¶æ–‡ä»¶
	@echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
	find . -type f -name '*.pyc' -delete
	find . -type d -name '__pycache__' -delete
	find . -type d -name '*.egg-info' -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name '.pytest_cache' -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name '.mypy_cache' -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name 'htmlcov' -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name '.coverage' -delete
	@echo "âœ… æ¸…ç†å®Œæˆ"

clean-all: clean ## æ¸…ç†æ‰€æœ‰ç”Ÿæˆæ–‡ä»¶ï¼ˆåŒ…æ‹¬è™šæ‹Ÿç¯å¢ƒï¼‰
	@echo "ğŸ§¹ æ·±åº¦æ¸…ç†..."
	rm -rf venv/ env/ .venv/
	rm -rf dist/ build/
	@echo "âœ… æ·±åº¦æ¸…ç†å®Œæˆ"

# ============================================================================
# è¿è¡Œ
# ============================================================================

run: ## è¿è¡Œä¸»ç¨‹åº
	@echo "ğŸš€ å¯åŠ¨ SIGHT ONE åç«¯..."
	$(PYTHON) drone_backend.py

run-dev: ## å¼€å‘æ¨¡å¼è¿è¡Œ
	@echo "ğŸš€ å¯åŠ¨å¼€å‘æ¨¡å¼..."
	$(PYTHON) drone_backend.py --debug

run-test-server: ## è¿è¡Œæµ‹è¯•æœåŠ¡å™¨
	@echo "ğŸ§ª å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨..."
	$(PYTHON) -m http.server 8000

# ============================================================================
# æ–‡æ¡£
# ============================================================================

docs: ## ç”Ÿæˆæ–‡æ¡£
	@echo "ğŸ“š ç”Ÿæˆæ–‡æ¡£..."
	pdoc --html --output-dir docs .
	@echo "âœ… æ–‡æ¡£å·²ç”Ÿæˆ: docs/"

docs-serve: ## å¯åŠ¨æ–‡æ¡£æœåŠ¡å™¨
	@echo "ğŸ“š å¯åŠ¨æ–‡æ¡£æœåŠ¡å™¨..."
	pdoc --http localhost:8080 .

# ============================================================================
# å¼€å‘å·¥å…·
# ============================================================================

shell: ## å¯åŠ¨ IPython shell
	@echo "ğŸ å¯åŠ¨ IPython..."
	ipython

notebook: ## å¯åŠ¨ Jupyter Notebook
	@echo "ğŸ““ å¯åŠ¨ Jupyter Notebook..."
	jupyter notebook

freeze: ## å¯¼å‡ºå½“å‰ç¯å¢ƒä¾èµ–
	@echo "ğŸ“ å¯¼å‡ºä¾èµ–åˆ—è¡¨..."
	$(PIP) freeze > requirements-frozen.txt
	@echo "âœ… å·²å¯¼å‡ºåˆ° requirements-frozen.txt"

upgrade: ## å‡çº§æ‰€æœ‰ä¾èµ–
	@echo "â¬†ï¸  å‡çº§ä¾èµ–åŒ…..."
	$(PIP) list --outdated --format=freeze | grep -v '^\-e' | cut -d = -f 1 | xargs -n1 $(PIP) install -U
	@echo "âœ… å‡çº§å®Œæˆ"

# ============================================================================
# Git æ“ä½œ
# ============================================================================

git-clean: ## æ¸…ç† Git æœªè·Ÿè¸ªçš„æ–‡ä»¶
	@echo "ğŸ§¹ æ¸…ç† Git æœªè·Ÿè¸ªæ–‡ä»¶..."
	git clean -fdx -e venv -e .env
	@echo "âœ… Git æ¸…ç†å®Œæˆ"

# ============================================================================
# éƒ¨ç½²
# ============================================================================

build: ## æ„å»ºåˆ†å‘åŒ…
	@echo "ğŸ“¦ æ„å»ºåˆ†å‘åŒ…..."
	$(PYTHON) setup.py sdist bdist_wheel
	@echo "âœ… æ„å»ºå®Œæˆ: dist/"

publish-test: build ## å‘å¸ƒåˆ° TestPyPI
	@echo "ğŸ“¤ å‘å¸ƒåˆ° TestPyPI..."
	twine upload --repository testpypi dist/*
	@echo "âœ… å‘å¸ƒå®Œæˆ"

publish: build ## å‘å¸ƒåˆ° PyPI
	@echo "ğŸ“¤ å‘å¸ƒåˆ° PyPI..."
	twine upload dist/*
	@echo "âœ… å‘å¸ƒå®Œæˆ"

# ============================================================================
# Docker (å¯é€‰)
# ============================================================================

docker-build: ## æ„å»º Docker é•œåƒ
	@echo "ğŸ³ æ„å»º Docker é•œåƒ..."
	docker build -t sight-one-backend:latest .
	@echo "âœ… é•œåƒæ„å»ºå®Œæˆ"

docker-run: ## è¿è¡Œ Docker å®¹å™¨
	@echo "ğŸ³ å¯åŠ¨ Docker å®¹å™¨..."
	docker run -p 8765:8765 sight-one-backend:latest

# ============================================================================
# å®ç”¨å·¥å…·
# ============================================================================

info: ## æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
	@echo "=========================================="
	@echo "  é¡¹ç›®ä¿¡æ¯"
	@echo "=========================================="
	@echo "Python ç‰ˆæœ¬: $(shell $(PYTHON) --version)"
	@echo "Pip ç‰ˆæœ¬: $(shell $(PIP) --version)"
	@echo "é¡¹ç›®ç›®å½•: $(PROJECT_DIR)"
	@echo "å·²å®‰è£…åŒ…æ•°é‡: $(shell $(PIP) list | wc -l)"
	@echo "=========================================="

check-deps: ## æ£€æŸ¥ä¾èµ–å†²çª
	@echo "ğŸ” æ£€æŸ¥ä¾èµ–å†²çª..."
	$(PIP) check

security-check: ## å®‰å…¨æ£€æŸ¥
	@echo "ğŸ”’ è¿è¡Œå®‰å…¨æ£€æŸ¥..."
	bandit -r . -f screen || true
	safety check --json || true

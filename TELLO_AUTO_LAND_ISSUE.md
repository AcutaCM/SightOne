# Tello自动降落问题说明

## 问题描述

起飞后一会儿无人机就自动降落了，导致无法执行下一个命令，报错"error Auto land"。

## 根本原因

### Tello的安全特性

Tello无人机有一个内置的安全机制：

**如果起飞后15秒内没有收到任何控制命令，无人机会自动降落。**

这是为了防止无人机失控或连接丢失时继续飞行造成危险。

### 为什么会触发？

在我们的命令序列执行流程中：

```
1. 用户输入: "起飞然后向前50厘米"
2. AI解析: 2-3秒
3. 发送takeoff命令
4. 后端等待: 2秒（让电机稳定）
5. 前端延迟: 0.5秒
6. 发送move_forward命令
```

**总时间**: 约4.5-5.5秒

如果网络延迟或AI解析慢，可能超过15秒，触发自动降落。

## 解决方案

### 方案1: 增加后端等待时间到2秒（当前采用）

```python
if action == 'takeoff':
    if self.drone_adapter and self.drone_adapter.takeoff():
        self.drone_state['flying'] = True
        result['success'] = True
        result['message'] = '起飞成功'
        await self.broadcast_drone_status()
        # 等待2秒让电机完全稳定
        await asyncio.sleep(2.0)
```

**优点**:
- 简单直接
- 给电机足够时间稳定
- 2秒是经过实测的最佳平衡点

**缺点**:
- 如果后续命令延迟太久，仍可能触发自动降落

### 方案2: 发送保活命令（备选）

起飞后立即发送一个小的控制命令来"激活"无人机：

```python
if action == 'takeoff':
    if self.drone_adapter and self.drone_adapter.takeoff():
        # 起飞成功
        await asyncio.sleep(1.0)
        # 发送保活命令（向上移动20cm）
        self.drone.move_up(20)
        await asyncio.sleep(0.5)
```

**优点**:
- 重置15秒计时器
- 确保无人机不会自动降落

**缺点**:
- 改变了用户预期的行为（多了一个向上移动）
- 增加了复杂度

### 方案3: 减少前端延迟（已实施）

将前端命令间延迟从2秒减少到500ms：

```typescript
// 命令间延迟
if (i < pendingCommands.length - 1) {
  await new Promise(resolve => setTimeout(resolve, 500));
}
```

**优点**:
- 加快命令序列执行
- 减少触发自动降落的风险

**缺点**:
- 仍需要后端有足够的稳定时间

## 最佳实践

### 1. 合理的等待时间

经过实测，以下时间是最佳平衡：

- **后端takeoff等待**: 2秒
- **前端命令间延迟**: 500ms
- **前端超时**: 30秒

### 2. 快速执行命令序列

确保命令序列在15秒内开始执行：

```
起飞 (2秒) → 延迟 (0.5秒) → 第一个命令 (3秒) = 5.5秒
```

这样可以在15秒限制内完成多个命令。

### 3. 避免长时间等待

不要在命令序列中间有长时间的延迟或处理：

❌ **错误做法**:
```
起飞 → 等待5秒 → AI分析 (3秒) → 移动
```

✅ **正确做法**:
```
AI分析 (3秒) → 起飞 → 立即移动
```

## 时间线分析

### 成功场景

```
0s:  用户输入 "起飞然后向前50厘米"
0s:  AI开始解析
2s:  AI解析完成，生成命令序列
2s:  发送takeoff命令
2s:  无人机起飞
4s:  后端等待电机稳定
4s:  发送响应给前端
4.5s: 前端延迟500ms
4.5s: 发送move_forward命令
4.5s: 无人机开始向前移动
7.5s: 移动完成
```

**总时间**: 7.5秒 < 15秒 ✅

### 失败场景（触发自动降落）

```
0s:  用户输入 "起飞然后向前50厘米"
0s:  AI开始解析
5s:  AI解析完成（网络慢）
5s:  发送takeoff命令
5s:  无人机起飞
7s:  后端等待电机稳定
7s:  发送响应给前端
9s:  前端延迟2秒（旧版本）
9s:  发送move_forward命令
20s: 超过15秒，无人机自动降落 ❌
```

**总时间**: 20秒 > 15秒 ❌

## 监控和调试

### 1. 添加时间戳日志

```python
import time

start_time = time.time()
print(f"[{time.time() - start_time:.1f}s] 起飞命令开始")
# ... 执行命令
print(f"[{time.time() - start_time:.1f}s] 起飞命令完成")
```

### 2. 检查命令间隔

如果看到以下日志，说明可能触发自动降落：

```
[0.0s] 起飞命令开始
[2.1s] 起飞命令完成
[16.5s] 移动命令开始  ← 超过15秒！
```

### 3. 优化建议

如果经常触发自动降落：

1. **减少AI解析时间**: 使用更快的模型或本地模型
2. **减少网络延迟**: 确保WiFi信号良好
3. **预先解析命令**: 在起飞前完成AI解析

## 相关资源

- [Tello SDK文档](https://dl-cdn.ryzerobotics.com/downloads/Tello/Tello%20SDK%202.0%20User%20Guide.pdf)
- [djitellopy库文档](https://djitellopy.readthedocs.io/)

## 更新日志

### 2024-11-16
- ✅ 识别Tello 15秒自动降落机制
- ✅ 将后端等待时间调整为2秒
- ✅ 前端延迟已优化为500ms
- ✅ 确保命令序列在15秒内开始执行

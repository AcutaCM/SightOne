# Tello 错误处理 - 视觉指南

## 错误显示示例

### 1. WebSocket 连接错误

```
┌─────────────────────────────────────────────────────────┐
│ 🔴 错误                                                  │
│                                                          │
│ WebSocket 连接失败,请确保无人机后端服务正在运行          │
│                                                          │
│ 建议:                                                    │
│ • 检查无人机后端服务是否正在运行                          │
│ • 确认端口 3002 未被占用                                 │
│ • 检查防火墙设置                                         │
│ • 尝试重启后端服务                                       │
│                                                          │
│ [重试]  [关闭]                                           │
└─────────────────────────────────────────────────────────┘
```

### 2. AI 解析错误 - API Key 未配置

```
┌─────────────────────────────────────────────────────────┐
│ 🔴 错误                                                  │
│                                                          │
│ AI API Key 未配置,请在设置中配置 API Key                 │
│                                                          │
│ 建议:                                                    │
│ • 前往设置页面                                           │
│ • 选择 AI 提供商                                         │
│ • 输入 API Key                                           │
│ • 保存设置                                               │
│                                                          │
│ [关闭]                                                   │
└─────────────────────────────────────────────────────────┘
```

### 3. 命令执行错误 - 电量不足

```
┌─────────────────────────────────────────────────────────┐
│ 🔴 错误                                                  │
│                                                          │
│ 电量不足,请充电后再试                                    │
│                                                          │
│ 建议:                                                    │
│ • 立即降落                                               │
│ • 更换电池                                               │
│ • 充电后再试                                             │
│ • 检查电池健康状态                                       │
│                                                          │
│ [关闭]                                                   │
└─────────────────────────────────────────────────────────┘
```

### 4. 重连中状态

```
┌─────────────────────────────────────────────────────────┐
│ 🟡 警告                                                  │
│                                                          │
│ 连接已断开,正在尝试重连 (3/5)...                         │
│                                                          │
│ 建议:                                                    │
│ • 检查网络连接                                           │
│ • 稍后重试                                               │
│ • 检查服务器响应时间                                     │
│                                                          │
│ [取消重连]                                               │
└─────────────────────────────────────────────────────────┘
```

## 连接状态指示器

### 状态面板

```
┌─────────────────────────────────────────────────────────┐
│ 无人机状态                                               │
│                                                          │
│ ● 已连接                                                 │
│                                                          │
│ ┌──────────┬──────────┬──────────┬──────────┐          │
│ │ 🔋 电池  │ 🌡️ 温度  │ ⬆️ 高度   │ 📶 信号  │          │
│ │ 85%      │ 45°C     │ 120cm    │ 90%      │          │
│ └──────────┴──────────┴──────────┴──────────┘          │
│                                                          │
│ [紧急停止]  [断开连接]                                   │
└─────────────────────────────────────────────────────────┘
```

### 连接状态变化

```
未连接 (灰色圆点)
    ↓ [点击连接]
连接中... (蓝色闪烁)
    ↓
已连接 (绿色圆点)
    ↓ [连接断开]
重连中... (黄色闪烁)
    ↓ [重连成功]
已连接 (绿色圆点)
    ↓ [重连失败]
连接错误 (红色圆点)
```

## 错误严重程度颜色

### 低严重度 (Low)

```
┌─────────────────────────────────────────────────────────┐
│ 🔵 信息                                                  │
│                                                          │
│ 命令参数超出有效范围: {"distance": 600}                  │
│                                                          │
│ 建议:                                                    │
│ • 距离范围: 20-500 厘米                                  │
│ • 角度范围: 1-360 度                                     │
│ • 检查参数值                                             │
│ • 使用默认参数                                           │
│                                                          │
│ [关闭]                                                   │
└─────────────────────────────────────────────────────────┘
```

### 中严重度 (Medium)

```
┌─────────────────────────────────────────────────────────┐
│ 🟡 警告                                                  │
│                                                          │
│ 命令 "takeoff" 执行超时                                  │
│                                                          │
│ 建议:                                                    │
│ • 检查无人机连接                                         │
│ • 减少命令复杂度                                         │
│ • 稍后重试                                               │
│ • 检查无人机响应时间                                     │
│                                                          │
│ [重试]  [关闭]                                           │
└─────────────────────────────────────────────────────────┘
```

### 高/严重 (High/Critical)

```
┌─────────────────────────────────────────────────────────┐
│ 🔴 严重                                                  │
│                                                          │
│ 无人机硬件错误,请检查无人机状态                           │
│                                                          │
│ 建议:                                                    │
│ • 检查螺旋桨                                             │
│ • 检查电机                                               │
│ • 重启无人机                                             │
│ • 联系技术支持                                           │
│                                                          │
│ [关闭]                                                   │
└─────────────────────────────────────────────────────────┘
```

## 错误处理流程图

### 用户输入处理流程

```
用户输入
    │
    ↓
┌─────────────────┐
│ 输入验证        │
│ - 检查是否为空  │
│ - 检查长度      │
│ - 检查危险词    │
└─────────────────┘
    │
    ├─ 验证失败 → 显示错误 → 提示重新输入
    │
    ↓ 验证通过
┌─────────────────┐
│ AI 解析         │
│ - 调用 AI API   │
│ - 解析响应      │
│ - 生成命令      │
└─────────────────┘
    │
    ├─ 解析失败 → 显示错误 → 提供建议
    │
    ↓ 解析成功
┌─────────────────┐
│ 显示命令列表    │
│ - 等待用户确认  │
└─────────────────┘
    │
    ↓ 用户确认
┌─────────────────┐
│ 执行命令        │
│ - 逐个发送      │
│ - 等待结果      │
│ - 显示进度      │
└─────────────────┘
    │
    ├─ 执行失败 → 显示错误 → 停止执行
    │
    ↓ 执行成功
显示结果
```

### WebSocket 连接流程

```
点击连接
    │
    ↓
┌─────────────────┐
│ 创建 WebSocket  │
│ 连接状态: 连接中│
└─────────────────┘
    │
    ├─ 连接失败 → 显示错误 → 提供重连
    │                │
    │                ↓
    │           自动重连 (指数退避)
    │                │
    │                ├─ 重连成功 → 已连接
    │                │
    │                ↓ 重连失败 (5次后)
    │           显示最终错误
    │
    ↓ 连接成功
┌─────────────────┐
│ 订阅状态更新    │
│ 连接状态: 已连接│
└─────────────────┘
    │
    ↓
接收状态更新
```

### 命令执行流程

```
开始执行
    │
    ↓
┌─────────────────┐
│ 检查连接状态    │
└─────────────────┘
    │
    ├─ 未连接 → 尝试连接 → 连接失败 → 显示错误
    │
    ↓ 已连接
┌─────────────────┐
│ 遍历命令列表    │
└─────────────────┘
    │
    ↓ 对每个命令
┌─────────────────┐
│ 发送命令        │
│ - 记录开始时间  │
│ - 发送到后端    │
└─────────────────┘
    │
    ↓
┌─────────────────┐
│ 等待结果        │
│ - 超时: 10秒    │
└─────────────────┘
    │
    ├─ 超时 → 记录错误 → 停止执行
    │
    ├─ 失败 → 记录错误 → 停止执行
    │
    ↓ 成功
┌─────────────────┐
│ 记录结果        │
│ - 记录结束时间  │
│ - 更新日志      │
└─────────────────┘
    │
    ↓
继续下一个命令
```

## 错误消息示例

### WebSocket 错误

| 错误类型 | 消息 | 图标 |
|---------|------|------|
| CONNECTION_FAILED | WebSocket 连接失败,请确保无人机后端服务正在运行 | 🔴 |
| CONNECTION_TIMEOUT | WebSocket 连接超时 | 🟡 |
| CONNECTION_CLOSED | WebSocket 连接已关闭 | 🟡 |
| NETWORK_ERROR | 网络连接失败,请检查网络设置 | 🔴 |

### AI 解析错误

| 错误类型 | 消息 | 图标 |
|---------|------|------|
| API_KEY_MISSING | AI API Key 未配置,请在设置中配置 API Key | 🔴 |
| API_KEY_INVALID | AI API Key 无效,请检查 API Key 是否正确 | 🔴 |
| API_RATE_LIMIT | API 请求频率超限,请稍后再试 | 🟡 |
| EMPTY_INPUT | 输入不能为空,请输入飞行指令 | 🔵 |
| UNSAFE_COMMAND | 检测到不安全的飞行指令,已拒绝执行 | 🔴 |

### 命令执行错误

| 错误类型 | 消息 | 图标 |
|---------|------|------|
| COMMAND_TIMEOUT | 命令 "takeoff" 执行超时 | 🟡 |
| DRONE_NOT_CONNECTED | 无人机未连接,请先连接无人机 | 🔴 |
| LOW_BATTERY | 电量不足,请立即降落并充电 | 🔴 |
| HARDWARE_ERROR | 无人机硬件错误,请检查无人机状态 | 🔴 |

## 用户交互示例

### 场景 1: 首次使用 - API Key 未配置

```
用户: 起飞

系统: 
┌─────────────────────────────────────────────────────────┐
│ 🔴 错误                                                  │
│                                                          │
│ AI API Key 未配置,请在设置中配置 API Key                 │
│                                                          │
│ 建议:                                                    │
│ • 前往设置页面                                           │
│ • 选择 AI 提供商                                         │
│ • 输入 API Key                                           │
│ • 保存设置                                               │
│                                                          │
│ [关闭]                                                   │
└─────────────────────────────────────────────────────────┘

用户: [点击关闭] → [前往设置] → [配置 API Key] → [返回]

用户: 起飞

系统: 我已经为你生成了以下飞行命令:
      1. takeoff
      
      是否执行这些指令?
      
      [执行指令]  [取消]
```

### 场景 2: 连接失败 - 自动重连

```
用户: [点击连接]

系统: 连接中...

系统:
┌─────────────────────────────────────────────────────────┐
│ 🔴 错误                                                  │
│                                                          │
│ WebSocket 连接失败,请确保无人机后端服务正在运行          │
│                                                          │
│ 建议:                                                    │
│ • 检查无人机后端服务是否正在运行                          │
│ • 确认端口 3002 未被占用                                 │
│ • 检查防火墙设置                                         │
│ • 尝试重启后端服务                                       │
│                                                          │
│ [重试]  [关闭]                                           │
└─────────────────────────────────────────────────────────┘

系统: 正在尝试重连 (1/5)...

系统: 正在尝试重连 (2/5)...

系统: 重连成功! 已连接到无人机后端
```

### 场景 3: 命令执行失败 - 电量不足

```
用户: 起飞并向前飞100厘米

系统: 我已经为你生成了以下飞行命令:
      1. takeoff
      2. move_forward (distance: 100)
      
      是否执行这些指令?

用户: [点击执行指令]

系统: 正在执行指令...
      进度: 1 / 2
      
      ✓ takeoff 执行成功
      
      进度: 2 / 2

系统:
┌─────────────────────────────────────────────────────────┐
│ 🔴 严重                                                  │
│                                                          │
│ 电量不足,请充电后再试                                    │
│                                                          │
│ 建议:                                                    │
│ • 立即降落                                               │
│ • 更换电池                                               │
│ • 充电后再试                                             │
│ • 检查电池健康状态                                       │
│                                                          │
│ [关闭]                                                   │
└─────────────────────────────────────────────────────────┘

系统: 执行完成! 成功: 1/2
```

## 响应式设计

### 桌面端 (>1024px)

```
┌─────────────────────────────────────────────────────────┐
│ 无人机状态面板 (完整显示)                                │
├─────────────────────────────────────────────────────────┤
│ 错误显示 (如果有)                                        │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 消息列表                                                 │
│                                                          │
├─────────────────────────────────────────────────────────┤
│ [历史] [输入框────────────────────────────────] [发送]   │
└─────────────────────────────────────────────────────────┘
```

### 平板端 (768px - 1024px)

```
┌───────────────────────────────────────────┐
│ 无人机状态面板 (紧凑显示)                 │
├───────────────────────────────────────────┤
│ 错误显示 (如果有)                         │
├───────────────────────────────────────────┤
│                                           │
│ 消息列表                                  │
│                                           │
├───────────────────────────────────────────┤
│ [历史] [输入框──────────────] [发送]      │
└───────────────────────────────────────────┘
```

### 移动端 (<768px)

```
┌─────────────────────────┐
│ 状态面板 (最小化)        │
├─────────────────────────┤
│ 错误 (如果有)            │
├─────────────────────────┤
│                         │
│ 消息列表                │
│                         │
├─────────────────────────┤
│ [历史]                  │
│ [输入框──────────]      │
│ [发送]                  │
└─────────────────────────┘
```

## 相关文档

- [完整文档](./TELLO_ERROR_HANDLING_COMPLETE.md)
- [快速参考](./TELLO_ERROR_HANDLING_QUICK_REFERENCE.md)
- [需求文档](../.kiro/specs/tello-purechat-integration/requirements.md)
- [设计文档](../.kiro/specs/tello-purechat-integration/design.md)

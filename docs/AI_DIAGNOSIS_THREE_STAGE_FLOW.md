# 🔬 AI诊断三阶段流程

## 概述

AI诊断系统采用**三阶段流程**，确保遮罩图的精确性和诊断报告的准确性。

---

## 三阶段流程

### 阶段1️⃣: AI生成遮罩提示词

**目的**: 让AI分析图像，生成专门用于Unipixel的精确描述

**输入**:
- 植株原始图像

**AI提示词**:
```
你是一位专业的植物病理学家。请仔细观察这张植株图像，识别图像中可能存在的病害或异常区域。

你的任务是生成一个简洁、精确的描述，用于指导图像分割系统标注病害区域。

要求：
1. 只描述病害或异常的具体部位和特征
2. 使用简洁的中文短语（10-20字）
3. 聚焦于视觉特征（颜色、形状、位置）
4. 不要包含诊断结论或建议

示例输出：
- "叶片上的黄褐色斑点区域"
- "茎部的深褐色腐烂部分"
- "果实表面的灰白色霉变组织"
```

**输出示例**:
- `"叶片上的黄褐色斑点区域"`
- `"茎部的深褐色腐烂部分"`
- `"叶缘的枯黄卷曲部位"`

**进度**: 33%

---

### 阶段2️⃣: Unipixel生成遮罩图

**目的**: 使用AI生成的专属提示词，让Unipixel精确标注病害区域

**输入**:
- 植株原始图像
- AI生成的遮罩提示词（例如："叶片上的黄褐色斑点区域"）

**API调用**:
```python
POST http://localhost:8000/infer_unipixel_base64

{
  "imageBase64": "data:image/png;base64,...",
  "query": "叶片上的黄褐色斑点区域",  # AI生成的专属提示词
  "sample_frames": 16
}
```

**输出**:
- 遮罩图（base64）
- Unipixel的描述

**进度**: 66%

---

### 阶段3️⃣: AI生成最终诊断报告

**目的**: 基于原图、遮罩图和所有上下文，生成完整的诊断报告

**输入**:
- 植株原始图像
- 遮罩图
- AI生成的遮罩提示词
- Unipixel的描述

**AI提示词**:
```
你是一位专业的植物病理学家。请基于提供的信息分析这张植株图像并提供详细的诊断报告。

植株ID: 2

可用信息：
- 原始植株图像
- 病害区域遮罩图：已生成
- AI识别的病害部位：叶片上的黄褐色斑点区域
- 遮罩区域描述：[Unipixel描述]

请按以下格式提供诊断报告（使用Markdown格式）：
[详细格式...]
```

**输出**:
- 完整的Markdown格式诊断报告
- 包含：诊断摘要、病害识别、严重程度、详细分析、建议措施、预防措施

**进度**: 100%

---

## 完整流程图

```
用户扫描植株QR码
    ↓
捕获植株图像
    ↓
┌─────────────────────────────────────┐
│ 阶段1: AI生成遮罩提示词 (33%)        │
├─────────────────────────────────────┤
│ 输入: 原始图像                       │
│ AI分析: 识别病害部位特征             │
│ 输出: "叶片上的黄褐色斑点区域"       │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 阶段2: Unipixel生成遮罩图 (66%)     │
├─────────────────────────────────────┤
│ 输入: 原始图像 + AI提示词            │
│ Unipixel: 精确标注病害区域           │
│ 输出: 遮罩图 + 描述                  │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 阶段3: AI生成诊断报告 (100%)        │
├─────────────────────────────────────┤
│ 输入: 原图 + 遮罩图 + 所有上下文     │
│ AI分析: 综合诊断                     │
│ 输出: 完整Markdown报告               │
└─────────────────────────────────────┘
    ↓
显示诊断报告
    ↓
导出PDF/HTML
```

---

## 优势

### 1. 精确的遮罩定位 🎯
- AI先分析图像，理解病害特征
- 生成专门针对该图像的描述
- Unipixel基于精确描述生成遮罩

### 2. 上下文丰富的诊断 📊
- 最终诊断包含完整上下文
- AI知道遮罩区域的具体含义
- 诊断更准确、更有针对性

### 3. 可追溯性 📝
- 保存AI生成的遮罩提示词
- 可以了解AI的分析思路
- 便于调试和优化

### 4. 降级友好 ⚡
- 如果Unipixel失败，仍可继续诊断
- 如果阶段1失败，使用默认提示词
- 确保系统鲁棒性

---

## 示例场景

### 场景：叶斑病诊断

**阶段1输出**:
```
"叶片中部的黄褐色不规则斑点"
```

**阶段2输出**:
```
遮罩图: [精确标注的黄褐色斑点区域]
描述: "检测到叶片中部多处黄褐色病变组织"
```

**阶段3输出**:
```markdown
## 诊断摘要
该植株叶片中部出现典型的叶斑病症状，病变区域呈黄褐色不规则斑点状，
属于早期感染阶段。

## 病害识别
- 主要病害：细菌性叶斑病
- 次要症状：轻微叶缘枯黄

## 严重程度
- 等级: 低
- 置信度: 85%
- 影响范围: 约占叶片面积的15%，主要集中在中部区域

## 详细分析
### 病害特征
根据遮罩图显示，病变区域主要分布在叶片中部，呈现黄褐色不规则斑点...

[更多内容...]
```

---

## 性能考虑

### 处理时间估算
- 阶段1 (AI分析): 3-5秒
- 阶段2 (Unipixel): 5-10秒
- 阶段3 (AI诊断): 5-8秒
- **总计**: 13-23秒

### 优化策略
1. **并行处理**: 某些步骤可以并行（如果不依赖前一步结果）
2. **缓存**: 缓存AI配置和连接
3. **超时控制**: 每个阶段设置合理超时
4. **降级**: 任何阶段失败都有降级方案

---

## 错误处理

### 阶段1失败
```python
try:
    mask_prompt = await ai_service.generate_mask_prompt(image)
except Exception as e:
    logger.warning(f"阶段1失败，使用默认提示词: {e}")
    mask_prompt = "病害区域"  # 降级到默认提示词
```

### 阶段2失败
```python
try:
    mask_result = await unipixel_client.generate_mask(image, mask_prompt)
except Exception as e:
    logger.warning(f"阶段2失败，继续诊断但不包含遮罩图: {e}")
    mask_result = None  # 继续诊断流程
```

### 阶段3失败
```python
try:
    report = await ai_service.diagnose(...)
except Exception as e:
    logger.error(f"阶段3失败，诊断中止: {e}")
    raise  # 无法继续，返回错误
```

---

## 配置选项

### 启用/禁用阶段
```python
DIAGNOSIS_CONFIG = {
    'enable_mask_prompt_generation': True,  # 阶段1
    'enable_unipixel': True,                # 阶段2
    'fallback_mask_prompt': '病害区域',     # 阶段1失败时的默认值
    'continue_without_mask': True           # 阶段2失败时是否继续
}
```

---

## 总结

三阶段流程确保了：
- ✅ 遮罩图的精确性（AI指导Unipixel）
- ✅ 诊断报告的准确性（完整上下文）
- ✅ 系统的鲁棒性（降级策略）
- ✅ 过程的可追溯性（保存中间结果）

这种设计充分利用了AI的理解能力和Unipixel的分割能力，实现了最佳的诊断效果！

---

**更新日期**: 2025-10-11  
**版本**: 1.0.0  
**状态**: ✅ 设计完成

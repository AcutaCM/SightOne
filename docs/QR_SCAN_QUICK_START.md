# QR码检测增强 - 快速开始指南

## 快速测试

### 1. 基础QR扫描

在工作流编辑器中:

1. 从节点库的"检测任务"分类拖拽"QR码扫描"节点到画布
2. 双击节点配置参数:
   - 超时时间: 10秒
   - 扫描区域: 全图
   - 多码检测: 否
3. 连接起始节点和QR扫描节点
4. 点击"运行"按钮

### 2. 多码检测示例

配置参数:
```
超时时间: 15秒
扫描区域: 中心区域
多码检测: 是
最大检测数: 10
聚合结果: 是
输出变量名: qr_results
```

### 3. 带验证的扫描

配置参数:
```
超时时间: 10秒
内容验证正则: ^plant_\d+$
必需前缀: plant_
最小长度: 7
最大长度: 15
解析格式: 自动识别
输出变量名: validated_qr
```

## 使用场景

### 场景1: 植株ID扫描

```
工作流:
[开始] → [起飞] → [移动到扫描位置] → [QR扫描] → [记录数据] → [降落] → [结束]

QR扫描配置:
- 扫描区域: 下半部分
- 验证正则: ^plant_\d+$
- 必需前缀: plant_
- 解析格式: 自动识别
```

### 场景2: 批量库存盘点

```
工作流:
[开始] → [起飞] → [循环开始] → [移动] → [QR扫描(多码)] → [记录] → [循环结束] → [降落] → [结束]

QR扫描配置:
- 多码检测: 是
- 最大检测数: 20
- 聚合结果: 是
- 解析格式: JSON
```

### 场景3: URL二维码识别

```
QR扫描配置:
- 验证正则: ^https?://
- 必需前缀: https://
- 解析格式: URL
- 最小长度: 10
```

## 访问结果数据

### 在后续节点中使用

QR扫描结果存储在工作流变量中，可以在后续节点中访问:

```javascript
// 访问扫描结果
const qrResults = context.variables.qr_results;

// 单码检测
if (qrResults.success && qrResults.count > 0) {
  const firstQR = qrResults.detections[0];
  console.log('QR内容:', firstQR.data);
  console.log('植株ID:', firstQR.plant_id);
  console.log('解析结果:', firstQR.parsed);
}

// 多码检测
if (qrResults.aggregated) {
  console.log('总数:', qrResults.aggregated.total);
  console.log('有效:', qrResults.aggregated.valid);
  console.log('植株ID列表:', qrResults.aggregated.plantIds);
}
```

## 常见问题

### Q: 扫描不到QR码怎么办?

A: 检查以下几点:
1. 确保QR码在摄像头视野内
2. 调整扫描区域设置
3. 增加超时时间
4. 检查光照条件
5. 启用"失败继续"选项避免工作流中断

### Q: 如何提高扫描速度?

A: 
1. 使用区域扫描而非全图
2. 单码模式比多码模式更快
3. 减少最大检测数
4. 关闭绘制标注

### Q: 验证规则如何编写?

A: 使用JavaScript正则表达式:
- 植株ID: `^plant_\d+$`
- URL: `^https?://`
- 邮箱: `^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$`
- 数字: `^\d+$`

### Q: 如何处理验证失败的QR码?

A: 验证失败的QR码:
- 不会添加到结果列表
- 在图像上显示红色边框
- 记录在日志中
- 可以通过聚合结果查看无效数量

## 性能建议

### 优化扫描性能

1. **使用合适的扫描区域**
   - 全图: 最慢但最全面
   - 中心: 平衡性能和覆盖
   - 自定义: 最快但需要精确定位

2. **限制检测数量**
   - 单码模式: 检测到第一个即停止
   - 多码模式: 设置合理的最大检测数

3. **简化验证规则**
   - 只使用必要的验证
   - 避免复杂的正则表达式

## 调试技巧

### 查看详细日志

在工作流执行时，控制面板会显示详细日志:

```
[14:30:25] 执行QR码扫描 - 超时: 10秒, 多码: 是
[14:30:26] QR扫描成功 - 检测到 3 个QR码 (有效: 2, 无效: 1)
[14:30:26] 植株ID: 123, 124
```

### 检查结果数据

在浏览器控制台查看完整结果:

```javascript
console.log(JSON.stringify(context.variables.qr_results, null, 2));
```

### 保存扫描图像

启用"保存图像"选项，扫描结果会包含base64编码的图像:

```javascript
const imageData = qrResults.image;
// 可以在<img>标签中显示
<img src={`data:image/jpeg;base64,${imageData}`} />
```

## 下一步

- 查看 `QR_SCAN_ENHANCEMENT_COMPLETE.md` 了解完整功能
- 尝试不同的扫描区域和验证规则
- 结合其他节点创建复杂工作流
- 查看示例工作流获取灵感

## 技术支持

如遇问题:
1. 检查Python后端是否运行
2. 查看浏览器控制台错误
3. 检查工作流执行日志
4. 验证pyzbar库是否正确安装

# MISSIONPAD功能测试指南

## 快速测试步骤

### 1. 启动后端服务
```bash
cd drone-analyzer-nextjs/python
python drone_backend.py
```

**期望输出**:
```
✓ djitellopy库加载成功
✓ OpenCV库加载成功
✓ 草莓检测器模块加载成功
✓ QR检测器模块加载成功
✓ 诊断工作流管理器模块加载成功
✓ YOLO模型管理器模块加载成功
✓ 任务控制器模块加载成功  ← 确认这一行
🚀 启动WebSocket服务器，端口: 3002
✅ WebSocket服务器已启动: ws://localhost:3002
```

### 2. 启动前端服务
```bash
cd drone-analyzer-nextjs
npm run dev
```

### 3. 准备Mission Pad
- 将PAD1和PAD6平放在地面
- 两个卡片相距约1-2米
- 确保光线充足
- 卡片平整无遮挡

### 4. 连接无人机
1. 打开Tello无人机电源
2. 连接到Tello WiFi (TELLO-XXXXXX)
3. 在浏览器打开 http://localhost:3000
4. 点击"连接无人机"按钮
5. 等待连接成功（显示电量）

**后端日志应显示**:
```
✅ 无人机连接成功，电量: 85%
✅ 任务控制器初始化成功
```

### 5. 启动挑战卡任务
1. 找到"挑战卡任务控制 MISSIONPAD"面板
2. 设置参数：
   - 任务轮次: 2 (首次测试建议少一点)
   - 执行高度: 80cm (首次测试建议低一点)
   - 卡停留时间: 3秒
3. 点击"开始任务"按钮

### 6. 观察任务执行

**无人机行为**:
1. ✈️ 自动起飞
2. 📏 调整到设定高度
3. 🔍 搜索PAD1
4. 📍 对齐到PAD1中心
5. ➡️ 飞向PAD6
6. ⏱️ 在PAD6停留3秒
7. ⬅️ 返回PAD1
8. ⏱️ 在PAD1停留3秒
9. 🔄 重复第5-8步（第2轮）
10. 🛬 准备降落位置
11. ⬇️ 安全降落

**前端显示**:
- 任务状态: "任务进行中..."
- 进度消息: "在挑战卡 1 停留 3 秒"
- 位置信息更新
- 系统日志滚动

**后端日志**:
```
🚁 启动挑战卡巡航任务: 轮次=2, 高度=80cm, 停留=3s
✅ 任务控制器初始化成功
Taking off
Adjusting height
Searching for challenge card
Detected challenge card ID: 1
Round 1/2
在挑战卡 1 停留 3 秒
飞向PAD6...
在挑战卡 6 停留 3 秒
返回PAD1...
Round 2/2
...
Mission complete: 2/2 rounds successful
Landing
✅ 任务执行完成，状态已重置
```

### 7. 停止任务（可选）
任务执行过程中，可以随时点击"停止任务"按钮中断任务。

## 测试检查清单

### 启动前检查
- [ ] 后端服务正常启动
- [ ] 前端服务正常启动
- [ ] 任务控制器模块加载成功
- [ ] Mission Pad准备就绪
- [ ] 无人机电量充足（>20%）
- [ ] WiFi连接稳定

### 连接检查
- [ ] 无人机成功连接
- [ ] 显示电量信息
- [ ] 任务控制器初始化成功
- [ ] 视频流正常显示

### 任务执行检查
- [ ] 点击"开始任务"有响应
- [ ] 无人机自动起飞
- [ ] 调整到设定高度
- [ ] 成功检测到PAD1
- [ ] 飞向PAD6
- [ ] 在PAD6停留指定时间
- [ ] 返回PAD1
- [ ] 完成所有轮次
- [ ] 自动降落

### 反馈检查
- [ ] 前端显示任务状态
- [ ] 位置信息实时更新
- [ ] 进度消息正确显示
- [ ] 系统日志记录完整
- [ ] 后端日志详细

### 异常处理检查
- [ ] 找不到PAD时旋转搜索
- [ ] 检测失败自动重试
- [ ] 停止任务立即响应
- [ ] 异常情况安全降落

## 常见问题

### Q1: 任务控制器未初始化
**症状**: 点击"开始任务"提示"任务控制器未初始化"

**解决方案**:
1. 检查后端日志是否有"✓ 任务控制器模块加载成功"
2. 确认无人机已连接
3. 重新连接无人机

### Q2: 无人机不起飞
**症状**: 点击"开始任务"后无人机没有反应

**解决方案**:
1. 检查电量（至少20%）
2. 确认WiFi连接稳定
3. 查看后端日志错误信息
4. 重启无人机和后端服务

### Q3: 找不到Mission Pad
**症状**: 无人机起飞后一直旋转搜索

**解决方案**:
1. 改善光线条件
2. 确保卡片平整
3. 调整卡片位置（更靠近起飞点）
4. 检查卡片是否损坏

### Q4: 飞行不稳定
**症状**: 无人机飞行时晃动或偏移

**解决方案**:
1. 检查室内是否有风
2. 降低飞行高度
3. 减少移动速度
4. 确保地面平整

### Q5: 任务中断
**症状**: 任务执行到一半停止

**解决方案**:
1. 查看后端日志错误信息
2. 检查电量是否充足
3. 确认WiFi连接稳定
4. 重新启动任务

## 调试技巧

### 1. 查看详细日志
后端日志会显示详细的执行信息：
```bash
# 在后端终端查看实时日志
python drone_backend.py
```

### 2. 检查WebSocket连接
在浏览器开发者工具中：
1. 打开F12
2. 切换到Network标签
3. 筛选WS（WebSocket）
4. 查看消息收发

### 3. 测试简化参数
首次测试建议使用：
- 轮次: 1
- 高度: 60cm
- 停留时间: 2秒

### 4. 单步测试
可以修改`mission_controller.py`添加更多日志：
```python
print(f"当前位置: PAD{self.drone.mission_pad_id}")
print(f"飞行状态: {self.drone.is_flying}")
```

## 性能指标

### 正常执行时间（参考）
- 起飞: 3-5秒
- 搜索PAD: 2-10秒
- PAD1→PAD6: 3-5秒
- PAD6→PAD1: 3-5秒
- 降落: 3-5秒

**单轮总时间**: 约20-40秒（不含停留时间）

### 电量消耗（参考）
- 单轮任务: 约5-10%
- 3轮任务: 约15-30%

建议电量至少保持在30%以上。

## 成功标准

任务成功执行应满足：
1. ✅ 无人机自动起飞
2. ✅ 成功检测到所有Mission Pad
3. ✅ 完成所有往返轮次
4. ✅ 在每个PAD停留指定时间
5. ✅ 自动安全降落
6. ✅ 前端显示完整反馈
7. ✅ 后端日志无错误

## 下一步

测试成功后，可以尝试：
1. 增加轮次数（最多10轮）
2. 调整飞行高度（50-200cm）
3. 修改停留时间（1-20秒）
4. 添加更多Mission Pad
5. 自定义飞行路径

## 技术支持

如遇问题，请提供：
1. 后端完整日志
2. 前端控制台错误
3. 任务参数设置
4. 无人机电量
5. Mission Pad布局照片

祝测试顺利！🚁
